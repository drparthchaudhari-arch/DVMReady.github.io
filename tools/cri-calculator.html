<!doctype html>
<html lang="en" data-mode="pro" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/assets/img/dvmready-logo.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#0c607d" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="CRI Calculator" />
    <title>CRI Calculator | DVMReady Tools</title>
    <meta name="description" content="Constant Rate Infusion calculator for veterinary use. Calculate drug CRI rates, dilutions, and syringe pump settings. Basic and Advanced modes." />
    <link rel="canonical" href="https://dvmready.com/tools/cri-calculator.html" />
    <link rel="stylesheet" href="/assets/css/tokens.css" />
    <link rel="stylesheet" href="/assets/css/portal.css" />
    <link rel="stylesheet" href="/assets/css/logo-styles.css" />
    <link rel="stylesheet" href="/assets/css/unified-calculator.css" />
    <link rel="stylesheet" href="/assets/css/floating-elements.css" />
    <script src="/assets/js/nav-status.js" defer></script>
    <script src="/assets/js/theme-toggle.js" defer></script>
    <script src="/assets/js/unified-calculator.js" defer></script>
    <script src="/assets/js/legal-compliance.js" defer></script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Veterinary CRI Calculator",
      "applicationCategory": "HealthApplication",
      "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
      "description": "Constant rate infusion calculator for veterinary use. Calculate drug CRI rates, dilutions, and syringe pump settings."
    }
    </script>
      <link rel="stylesheet" href="/assets/css/clinic-utilities.css" />
    <script src="/assets/js/clinic-utilities.js" defer></script>
  </head>
  <body class="pc-page pc-page--study no-js">
    <div class="pc-ambient-container">
      <div class="pc-ambient-orb pc-ambient-orb--1"></div>
      <div class="pc-ambient-orb pc-ambient-orb--2"></div>
      <div class="pc-ambient-orb pc-ambient-orb--3"></div>
      <div class="pc-ambient-shape pc-ambient-shape--circle"></div>
      <div class="pc-ambient-shape pc-ambient-shape--square"></div>
      <div class="pc-ambient-shape pc-ambient-shape--triangle"></div>
    </div>

    <div class="pc-toast-container" role="status" aria-live="polite" aria-atomic="true"></div>
    <div class="pc-mobile-menu-overlay" aria-hidden="true"></div>

    <div class="pc-mobile-menu" id="pc-mobile-menu" aria-hidden="true">
      <div class="pc-mobile-menu__header">
        <span class="pc-mobile-menu__title">Menu</span>
        <button type="button" class="pc-mobile-menu__close" aria-label="Close menu">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <nav class="pc-mobile-menu__nav" aria-label="Mobile navigation">
        <a class="pc-mobile-nav-link" href="/">
          <span class="pc-mobile-nav-link__icon">üè†</span>
          <span class="pc-mobile-nav-link__text">Home</span>
        </a>
        <a class="pc-mobile-nav-link pc-is-active" href="/tools/">
          <span class="pc-mobile-nav-link__icon">üß∞</span>
          <span class="pc-mobile-nav-link__text">Tools</span>
        </a>

        <a class="pc-mobile-nav-link" href="/search.html">
          <span class="pc-mobile-nav-link__icon">üîç</span>
          <span class="pc-mobile-nav-link__text">Search</span>
        </a>
        <a class="pc-mobile-nav-link" href="/account/">
          <span class="pc-mobile-nav-link__icon">üë§</span>
          <span class="pc-mobile-nav-link__text">Account</span>
        </a>
      </nav>
    </div>

    <a class="pc-skip-link" href="#pc-main">Skip to main content</a>

    <nav class="pc-portal-nav" aria-label="Global portal navigation">
      <div class="pc-portal-nav__inner">
        <a class="pc-logo" href="/">
          <img src="/assets/img/dvmready-logo.png" alt="" class="pc-logo__img" aria-hidden="true">
          <span class="pc-logo__text">DVMReady</span>
        </a>
        <div class="pc-nav-group">
          <a class="pc-nav-link" href="/">Home</a>
          <a class="pc-nav-link pc-is-active" href="/tools/">Tools</a>
          <a class="pc-nav-link" href="/search.html">Search</a>
          <a class="pc-nav-link" href="/account/">Account</a>
          <button type="button" class="pc-mobile-toggle" aria-label="Toggle mobile menu">
            <span class="pc-mobile-toggle__bar"></span>
            <span class="pc-mobile-toggle__bar"></span>
            <span class="pc-mobile-toggle__bar"></span>
          </button>
        </div>
      </div>
    </nav>

    <main id="pc-main" class="calc-container" role="main">
      <header class="calc-header">
        <div class="calc-header__icon">üíâ</div>
        <h1 class="calc-header__title">CRI Calculator</h1>
        <p class="calc-header__subtitle">Constant Rate Infusion calculations. Basic for common CRIs, Advanced for custom dilutions and protocols.</p>
      </header>

      <div class="calc-mode-toggle">
        <button class="calc-mode-btn active" data-mode="basic"><span>‚ö° Basic</span></button>
        <button class="calc-mode-btn" data-mode="advanced"><span>üî¨ Advanced</span></button>
      </div>

      <div class="calc-card" id="cri-calculator" data-calc="cri">
        <div class="calc-card__header">
          <h2 class="calc-card__title">
            <span id="mode-icon">‚ö°</span>
            <span id="mode-title">Common CRI Protocols</span>
          </h2>
          <p class="calc-card__subtitle" id="mode-subtitle">Quick setup for standard veterinary CRIs</p>
        </div>

        <div class="calc-card__body">
          <!-- Species -->
          <div class="calc-form-group">
            <label class="calc-label">Species</label>
            <div class="calc-species-grid">
              <button type="button" class="calc-species-btn active" data-species="dog">üêï<span class="calc-species-btn__label">Dog</span></button>
              <button type="button" class="calc-species-btn" data-species="cat">üêà<span class="calc-species-btn__label">Cat</span></button>
            </div>
          </div>

          <!-- Weight -->
          <div class="calc-form-group">
            <label class="calc-label">Weight</label>
            <div class="calc-input-wrapper">
              <input type="number" class="calc-input calc-input--with-unit" id="weight" placeholder="10" min="0.1" step="0.1" data-conversion="weight" data-unit="kg">
              <div class="calc-input-unit">
                <button type="button" class="calc-unit-btn active" data-unit="kg">kg</button>
                <button type="button" class="calc-unit-btn" data-unit="lb">lb</button>
                <button type="button" class="calc-unit-btn" data-unit="g">g</button>
              </div>
            </div>
          </div>

          <!-- BASIC: CRI Protocol -->
          <div class="calc-form-group" id="basic-options">
            <label class="calc-label">CRI Protocol <span class="calc-label__hint">‚Äî concentrations editable below</span></label>
            <select class="calc-select" id="cri-protocol">
              <option value="">Select protocol...</option>
              <optgroup label="Analgesia">
                <option value="morphine">Morphine 0.2 mg/kg/hr (10 mg/mL)</option>
                <option value="fentanyl">Fentanyl 3 mcg/kg/hr (50 mcg/mL)</option>
                <option value="hydromorphone">Hydromorphone 0.05 mg/kg/hr (2 mg/mL)</option>
                <option value="buprenorphine">Buprenorphine 1.2 mcg/kg/hr (0.3 mg/mL)</option>
                <option value="ketamine">Ketamine 0.3 mg/kg/hr (100 mg/mL)</option>
                <option value="lidocaine">Lidocaine 35 mcg/kg/min (20 mg/mL)</option>
              </optgroup>
              <optgroup label="Sedation/Anesthesia">
                <option value="dexmed">Dexmedetomidine 0.75 mcg/kg/hr (500 mcg/mL)</option>
                <option value="propofol">Propofol 0.2 mg/kg/min (10 mg/mL)</option>
                <option value="midazolam">Midazolam 0.1 mg/kg/hr (5 mg/mL)</option>
              </optgroup>
              <optgroup label="Cardiac/Vasoactive">
                <option value="dopamine">Dopamine 10 mcg/kg/min (40 mg/mL)</option>
                <option value="dobutamine">Dobutamine 10 mcg/kg/min (12.5 mg/mL)</option>
                <option value="epinephrine_cri">Epinephrine 0.1 mcg/kg/min (1 mg/mL)</option>
                <option value="norepinephrine">Norepinephrine 0.1 mcg/kg/min (1 mg/mL)</option>
              </optgroup>
              <optgroup label="GI/Miscellaneous">
                <option value="metoclopramide">Metoclopramide 1 mg/kg/hr (5 mg/mL)</option>
                <option value="insulin">Insulin 0.05 U/kg/hr (100 U/mL)</option>
              </optgroup>
            </select>
            
            <!-- Editable Protocol Parameters -->
            <div id="protocol-details" style="margin-top: 1rem; padding: 1rem; background: var(--calc-bg-2); border-radius: var(--calc-radius-md); display: none;">
              <div style="display: grid; gap: 0.75rem;">
                <div class="calc-form-group" style="margin: 0;">
                  <label class="calc-label" style="font-size: 0.8rem;">Dose Rate</label>
                  <div class="calc-input-wrapper">
                    <input type="number" class="calc-input" id="protocol-dose-rate" step="0.001">
                    <span id="protocol-dose-unit" style="padding: 0 0.75rem; color: var(--calc-text-muted);"></span>
                  </div>
                </div>
                <div class="calc-form-group" style="margin: 0;">
                  <label class="calc-label" style="font-size: 0.8rem;">Drug Concentration</label>
                  <div class="calc-input-wrapper">
                    <input type="number" class="calc-input" id="protocol-conc" step="0.001">
                    <span id="protocol-conc-unit" style="padding: 0 0.75rem; color: var(--calc-text-muted);"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Fluid Rate -->
          <div class="calc-form-group">
            <label class="calc-label">Fluid Rate</label>
            <div class="calc-input-wrapper">
              <input type="number" class="calc-input calc-input--with-unit" id="fluid-rate" placeholder="5" value="5" min="0.1" step="0.1">
              <div class="calc-input-unit">
                <button type="button" class="calc-unit-btn active" data-unit="ml">mL/hr</button>
              </div>
            </div>
            <p style="font-size: 0.8rem; color: var(--calc-text-muted); margin-top: 0.25rem;">Rate of IV fluid administration</p>
          </div>

          <!-- ADVANCED: Custom CRI -->
          <div class="calc-advanced" id="advanced-options" style="display: none;">
            <h3 class="calc-advanced__title">üî¨ Custom CRI Configuration</h3>

            <div class="calc-form-group">
              <label class="calc-label">Drug Name</label>
              <input type="text" class="calc-input" id="custom-drug-name" placeholder="e.g., Metoclopramide">
            </div>

            <div class="calc-form-group">
              <label class="calc-label">Desired Dose Rate</label>
              <div class="calc-input-wrapper">
                <input type="number" class="calc-input calc-input--with-unit" id="desired-dose" placeholder="1" min="0.0001" step="0.0001">
                <div class="calc-input-unit">
                  <button type="button" class="calc-unit-btn active" data-unit="mg">mg</button>
                  <button type="button" class="calc-unit-btn" data-unit="mcg">mcg</button>
                </div>
              </div>
            </div>

            <div class="calc-form-group">
              <label class="calc-label">Per</label>
              <select class="calc-select" id="dose-time-unit">
                <option value="kg_hr">kg/hr</option>
                <option value="kg_min">kg/min</option>
                <option value="hr">hr (total)</option>
                <option value="min">min (total)</option>
              </select>
            </div>

            <div class="calc-form-group">
              <label class="calc-label">Drug Concentration</label>
              <div class="calc-input-wrapper">
                <input type="number" class="calc-input calc-input--with-unit" id="drug-conc" placeholder="10" min="0.0001" step="0.0001">
                <div class="calc-input-unit">
                  <button type="button" class="calc-unit-btn active" data-unit="mg_ml">mg/mL</button>
                  <button type="button" class="calc-unit-btn" data-unit="mcg_ml">mcg/mL</button>
                </div>
              </div>
            </div>

            <div class="calc-form-group">
              <label class="calc-label">Dilution Volume</label>
              <div class="calc-input-wrapper">
                <input type="number" class="calc-input calc-input--with-unit" id="dilution-vol" placeholder="250" value="250" min="1">
                <div class="calc-input-unit">
                  <button type="button" class="calc-unit-btn active" data-unit="ml">mL</button>
                  <button type="button" class="calc-unit-btn" data-unit="l">L</button>
                </div>
              </div>
            </div>

            <div class="calc-form-group">
              <label class="calc-label">Syringe/Drip Set</label>
              <select class="calc-select" id="delivery-method">
                <option value="syringe_pump">Syringe Pump (mL/hr)</option>
                <option value="buretrol">Buretrol (60 gtt/mL)</option>
                <option value="macrodrip">Macro Drip (10-20 gtt/mL)</option>
                <option value="microdrip">Micro Drip (60 gtt/mL)</option>
              </select>
            </div>
          </div>

          <button type="button" class="calc-btn" id="calculate-btn">
            <span>üíâ</span> Calculate CRI
          </button>

          <!-- Results -->
          <div class="calc-results" id="results" style="display: none;">
            <!-- Primary: Amount to add -->
            <div class="calc-result-card">
              <p class="calc-result-card__label">Drug Volume to Add</p>
              <p class="calc-result-card__value">
                <span id="result-volume">--</span>
                <span class="calc-result-card__unit">mL</span>
              </p>
              <p class="calc-result-card__range" id="volume-instruction"></p>
            </div>

            <!-- Concentration in bag -->
            <div class="calc-result-card">
              <p class="calc-result-card__label">Final Concentration</p>
              <p class="calc-result-card__value">
                <span id="result-conc">--</span>
                <span class="calc-result-card__unit">mg/mL</span>
              </p>
            </div>

            <!-- Dose verification -->
            <div class="calc-result-card">
              <p class="calc-result-card__label">Dose Being Delivered</p>
              <p class="calc-result-card__value">
                <span id="result-dose">--</span>
                <span class="calc-result-card__unit" id="dose-unit">mg/kg/hr</span>
              </p>
            </div>

            <!-- Syringe rate (if applicable) -->
            <div class="calc-result-card" id="syringe-result" style="display: none;">
              <p class="calc-result-card__label">Syringe Pump Rate</p>
              <p class="calc-result-card__value">
                <span id="result-syringe">--</span>
                <span class="calc-result-card__unit">mL/hr</span>
              </p>
            </div>

            <div class="calc-actions">
              <button class="calc-action-btn" id="copy-btn">üìã Copy</button>
              <button class="calc-action-btn" onclick="window.print()">üñ®Ô∏è Print</button>
              <button class="calc-action-btn" id="reset-btn">‚Ü∫ Reset</button>
            </div>

            <div class="calc-details">
              <button type="button" class="calc-details__trigger">
                <span>üìã Show Dilution Details</span>
                <svg class="calc-details__trigger-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="calc-details__content">
                <div class="calc-details__inner" id="calculation-details"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="calc-card__footer">
          <p style="font-size: 0.8rem; color: var(--calc-text-muted); margin: 0; text-align: center;">
            ‚ö†Ô∏è Always double-check CRI calculations. Monitor patients on CRIs closely.
          </p>
        </div>
      </div>

      <div style="margin-top: 2rem; text-align: center;">
        <p style="font-size: 0.875rem; color: var(--calc-text-muted); margin-bottom: 1rem;">Related Calculators</p>
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem;">
          <a href="/tools/dose-calculator.html" class="calc-chip">üíä Dose Calculator</a>
          <a href="/tools/fluid-calculator.html" class="calc-chip">üíß Fluid Calculator</a>
          <a href="/tools/insulin-cri-planner.html" class="calc-chip">ü©∫ Insulin CRI</a>
        </div>
      </div>
    </main>

    <script>
    (function() {
      const els = {
        modeBtns: document.querySelectorAll('.calc-mode-btn'),
        speciesBtns: document.querySelectorAll('.calc-species-btn'),
        weightInput: document.getElementById('weight'),
        protocol: document.getElementById('cri-protocol'),
        fluidRate: document.getElementById('fluid-rate'),
        advancedOptions: document.getElementById('advanced-options'),
        customDrugName: document.getElementById('custom-drug-name'),
        desiredDose: document.getElementById('desired-dose'),
        doseTimeUnit: document.getElementById('dose-time-unit'),
        drugConc: document.getElementById('drug-conc'),
        dilutionVol: document.getElementById('dilution-vol'),
        deliveryMethod: document.getElementById('delivery-method'),
        calculateBtn: document.getElementById('calculate-btn'),
        results: document.getElementById('results'),
        resultVolume: document.getElementById('result-volume'),
        volumeInstruction: document.getElementById('volume-instruction'),
        resultConc: document.getElementById('result-conc'),
        resultDose: document.getElementById('result-dose'),
        doseUnit: document.getElementById('dose-unit'),
        syringeResult: document.getElementById('syringe-result'),
        resultSyringe: document.getElementById('result-syringe'),
        calcDetails: document.querySelector('.calc-details'),
        copyBtn: document.getElementById('copy-btn'),
        resetBtn: document.getElementById('reset-btn')
      };

      let currentMode = 'basic';
      let currentSpecies = 'dog';

      const CRI_PROTOCOLS = {
        // Analgesics
        morphine: { name: 'Morphine', dose: 0.2, unit: 'mg/kg/hr', conc: 10, concUnit: 'mg/mL', range: '0.1-0.3', notes: 'Opioid analgesic. Monitor for sedation/respiratory depression.' },
        fentanyl: { name: 'Fentanyl', dose: 3, unit: 'mcg/kg/hr', conc: 50, concUnit: 'mcg/mL', range: '2-5', notes: 'Potent opioid. 50-100x more potent than morphine.' },
        hydromorphone: { name: 'Hydromorphone', dose: 0.05, unit: 'mg/kg/hr', conc: 2, concUnit: 'mg/mL', range: '0.025-0.1', notes: 'Synthetic opioid. 5x more potent than morphine.' },
        buprenorphine: { name: 'Buprenorphine', dose: 1.2, unit: 'mcg/kg/hr', conc: 0.3, concUnit: 'mg/mL', range: '0.5-2.4', notes: 'Partial agonist. Ceiling effect on respiratory depression.' },
        ketamine: { name: 'Ketamine', dose: 0.3, unit: 'mg/kg/hr', conc: 100, concUnit: 'mg/mL', range: '0.12-0.6', notes: 'NMDA antagonist. Good for neuropathic pain. Can cause dysphoria.' },
        lidocaine: { name: 'Lidocaine', dose: 35, unit: 'mcg/kg/min', conc: 20, concUnit: 'mg/mL', range: '25-50', notes: 'Class IB antiarrhythmic. Also used for analgesia/ileus.' },
        
        // Sedation/Anesthesia
        dexmed: { name: 'Dexmedetomidine', dose: 0.75, unit: 'mcg/kg/hr', conc: 500, concUnit: 'mcg/mL', range: '0.5-1', notes: 'Alpha-2 agonist. Provides sedation/analgesia. Can cause bradycardia.' },
        propofol: { name: 'Propofol', dose: 0.2, unit: 'mg/kg/min', conc: 10, concUnit: 'mg/mL', range: '0.1-0.4', notes: 'IV anesthetic. Titrate to effect. Apnea common with boluses.' },
        midazolam: { name: 'Midazolam', dose: 0.1, unit: 'mg/kg/hr', conc: 5, concUnit: 'mg/mL', range: '0.05-0.2', notes: 'Benzodiazepine. Anxiolytic/amnestic. Reversible with flumazenil.' },
        
        // Cardiac/Vasoactive
        dopamine: { name: 'Dopamine', dose: 10, unit: 'mcg/kg/min', conc: 40, concUnit: 'mg/mL', range: '2-20', notes: 'Dose-dependent: 2-5 (renal), 5-10 (cardiac), >10 (vasoconstriction).' },
        dobutamine: { name: 'Dobutamine', dose: 10, unit: 'mcg/kg/min', conc: 12.5, concUnit: 'mg/mL', range: '2-20', notes: 'Beta-1 agonist. Increases contractility with less arrhythmias than dopamine.' },
        epinephrine_cri: { name: 'Epinephrine CRI', dose: 0.1, unit: 'mcg/kg/min', conc: 1, concUnit: 'mg/mL', range: '0.05-1', notes: 'Alpha/beta agonist. Last resort for severe shock/bradycardia.' },
        norepinephrine: { name: 'Norepinephrine', dose: 0.1, unit: 'mcg/kg/min', conc: 1, concUnit: 'mg/mL', range: '0.05-1', notes: 'Alpha agonist with beta activity. First-line for vasodilatory shock.' },
        
        // GI/Misc
        metoclopramide: { name: 'Metoclopramide', dose: 1, unit: 'mg/kg/hr', conc: 5, concUnit: 'mg/mL', range: '0.5-2', notes: 'Prokinetic/antiemetic. Contraindicated with GI obstruction.' },
        insulin: { name: 'Insulin', dose: 0.05, unit: 'U/kg/hr', conc: 100, concUnit: 'U/mL', range: '0.025-0.1', notes: 'DKA management. Monitor glucose hourly. Have dextrose available.' }
      };

      els.modeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          currentMode = btn.dataset.mode;
          els.modeBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          document.getElementById('mode-icon').textContent = currentMode === 'basic' ? '‚ö°' : 'üî¨';
          document.getElementById('mode-title').textContent = currentMode === 'basic' ? 'Common CRI Protocols' : 'Custom CRI Configuration';
          document.getElementById('mode-subtitle').textContent = currentMode === 'basic' ? 'Quick setup for standard veterinary CRIs' : 'Full control over CRI parameters';
          
          els.advancedOptions.style.display = currentMode === 'advanced' ? 'block' : 'none';
        });
      });

      els.speciesBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          currentSpecies = btn.dataset.species;
          els.speciesBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });

      // Protocol selection - show editable details
      const protocolDetails = document.getElementById('protocol-details');
      const protocolDoseRate = document.getElementById('protocol-dose-rate');
      const protocolDoseUnit = document.getElementById('protocol-dose-unit');
      const protocolConc = document.getElementById('protocol-conc');
      const protocolConcUnit = document.getElementById('protocol-conc-unit');
      let currentProtocol = null;

      els.protocol.addEventListener('change', () => {
        const protocolKey = els.protocol.value;
        if (protocolKey && CRI_PROTOCOLS[protocolKey]) {
          currentProtocol = CRI_PROTOCOLS[protocolKey];
          protocolDetails.style.display = 'block';
          
          // Populate editable fields
          protocolDoseRate.value = currentProtocol.dose;
          protocolDoseUnit.textContent = currentProtocol.unit;
          protocolConc.value = currentProtocol.conc;
          protocolConcUnit.textContent = currentProtocol.concUnit;
        } else {
          protocolDetails.style.display = 'none';
          currentProtocol = null;
        }
      });

      function calculate() {
        const weight = parseFloat(els.weightInput.value);
        const fluidRate = parseFloat(els.fluidRate.value);
        
        if (!weight || !fluidRate) {
          alert('Please enter weight and fluid rate');
          return;
        }

        let drugVolume, finalConc, actualDose, drugName, doseUnit;

        if (currentMode === 'basic' && els.protocol.value) {
          const protocol = CRI_PROTOCOLS[els.protocol.value];
          drugName = protocol.name;
          
          // Use editable values if available, otherwise use protocol defaults
          const doseInput = parseFloat(protocolDoseRate.value) || protocol.dose;
          const concInput = parseFloat(protocolConc.value) || protocol.conc;
          doseUnit = protocol.unit;
          
          // Convert all to mg/kg/hr for calculation
          let doseMgKgHr = doseInput;
          if (protocol.unit === 'mcg/kg/hr') doseMgKgHr = doseInput / 1000;
          else if (protocol.unit === 'U/kg/hr') doseMgKgHr = doseInput; // Keep units for insulin
          else if (protocol.unit === 'mg/kg/min') doseMgKgHr = doseInput * 60;
          else if (protocol.unit === 'mcg/kg/min') doseMgKgHr = (doseInput * 60) / 1000;
          
          let concMgMl = concInput;
          if (protocol.concUnit === 'mcg/mL') concMgMl = concInput / 1000;
          if (protocol.concUnit === 'U/mL') concMgMl = concInput; // Keep units for insulin
          
          // Drug needed per hour
          const drugNeededHr = doseMgKgHr * weight;
          
          // Volume to add to dilution (mL)
          drugVolume = drugNeededHr / concMgMl;
          
          // Calculate final concentration
          const dilutionVol = 250;
          finalConc = (drugVolume * concMgMl) / dilutionVol;
          actualDose = doseInput;
          
          els.doseUnit.textContent = protocol.unit;
        } else if (currentMode === 'advanced') {
          drugName = els.customDrugName.value || 'Custom Drug';
          const desiredDose = parseFloat(els.desiredDose.value) || 0;
          const timeUnit = els.doseTimeUnit.value;
          const conc = parseFloat(els.drugConc.value) || 1;
          const dilVol = parseFloat(els.dilutionVol.value) || 250;
          
          let doseMgKgHr = desiredDose;
          if (timeUnit === 'mcg') doseMgKgHr = desiredDose / 1000;
          if (timeUnit.includes('min')) doseMgKgHr = desiredDose * 60;
          
          const drugNeededHr = doseMgKgHr * weight;
          drugVolume = drugNeededHr / conc;
          finalConc = (drugVolume * conc) / dilVol;
          actualDose = doseMgKgHr;
          
          els.doseUnit.textContent = timeUnit.replace('_', '/');
        }

        if (drugVolume) {
          els.resultVolume.textContent = drugVolume < 0.1 ? drugVolume.toFixed(3) : drugVolume.toFixed(2);
          els.volumeInstruction.textContent = `Add ${drugVolume < 0.1 ? drugVolume.toFixed(3) : drugVolume.toFixed(2)} mL drug to ${els.dilutionVol?.value || 250} mL fluid bag`;
          els.resultConc.textContent = finalConc.toFixed(4);
          els.resultDose.textContent = actualDose.toFixed(currentMode === 'basic' ? 2 : 3);
          
          // Show warning for very small volumes
          const calcDetails = document.getElementById('calculation-details');
          let warningText = '';
          if (drugVolume < 0.1) {
            warningText = '<div style="color: #f59e0b; margin-bottom: 1rem;">‚ö†Ô∏è Small volume - consider making more concentrated solution or using a syringe pump for accuracy.</div>';
          }
          if (currentProtocol && currentProtocol.notes) {
            warningText += `<div style="color: var(--calc-text-muted); font-size: 0.9rem; margin-bottom: 1rem;">‚ÑπÔ∏è ${currentProtocol.notes}</div>`;
          }
          calcDetails.innerHTML = warningText;
          
          els.results.style.display = 'block';
          els.results.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }

      els.calculateBtn.addEventListener('click', calculate);

      els.copyBtn.addEventListener('click', () => {
        const protocolName = els.protocol.value ? CRI_PROTOCOLS[els.protocol.value]?.name : (els.customDrugName.value || 'Custom CRI');
        const dilutionVol = els.dilutionVol?.value || 250;
        const text = `${protocolName} CRI:\n` +
          `‚Ä¢ Add ${els.resultVolume.textContent} mL drug to ${dilutionVol} mL fluid bag\n` +
          `‚Ä¢ Final concentration: ${els.resultConc.textContent} mg/mL\n` +
          `‚Ä¢ Delivering: ${els.resultDose.textContent} ${els.doseUnit.textContent}\n` +
          `‚Ä¢ Fluid rate: ${els.fluidRate.value} mL/hr`;
        navigator.clipboard.writeText(text).then(() => {
          els.copyBtn.textContent = '‚úì Copied!';
          setTimeout(() => els.copyBtn.textContent = 'üìã Copy', 2000);
        });
      });

      els.resetBtn.addEventListener('click', () => {
        els.weightInput.value = '';
        els.protocol.value = '';
        els.results.style.display = 'none';
      });

      els.calcDetails.querySelector('.calc-details__trigger').addEventListener('click', () => {
        els.calcDetails.classList.toggle('open');
      });
    })();
    </script>
  </body>
</html>
