/**
 * Universal Calculator Print Utility
 * Professional print output with legal compliance
 * 
 * Legal Disclaimer: All print outputs include required disclaimers stating
 * that calculations are for educational purposes only and not a substitute
 * for professional veterinary judgment.
 */

;(function() {
  'use strict'

  const PrintUtil = {
    // Default legal disclaimer
    legalDisclaimer: `
      <strong>‚ö†Ô∏è IMPORTANT LEGAL NOTICE</strong><br><br>
      This calculation is generated by DVMReady, an educational tool for veterinary professionals and students.<br><br>
      <strong>NOT A SUBSTITUTE FOR PROFESSIONAL JUDGMENT:</strong> These calculations are estimates based on published dosing references 
      (Plumb's Veterinary Drug Handbook, Merck Veterinary Manual, FDA labels). Always verify with current formularies, 
      consider patient-specific factors (age, weight, renal/hepatic function, concurrent medications), and use your 
      professional judgment before administering any medication.<br><br>
      <strong>CONTROLLED SUBSTANCES:</strong> Access to controlled substance dosing requires appropriate DEA licensure. 
      All calculations involving controlled substances are logged for audit purposes.<br><br>
      <strong>LIABILITY:</strong> DVMReady and its operators assume no liability for clinical decisions made using this tool. 
      The user assumes full responsibility for verifying all calculations and ensuring patient safety.<br><br>
      Generated: ${new Date().toLocaleString()} | dvmready.com | For educational use only.
    `,

    // Print header template
    printHeader: `
      <div class="print-header-meta">
        <span>üìÖ Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</span>
        <span>üåê dvmready.com/tools/</span>
      </div>
    `,

    // Print footer template
    printFooter: `
      <div class="print-legal-footer">
        ${this.legalDisclaimer}
      </div>
    `,

    /**
     * Initialize print functionality for a calculator
     * @param {Object} options - Configuration options
     * @param {string} options.calculatorName - Name of the calculator
     * @param {string} options.resultsSelector - CSS selector for results container
     * @param {Function} options.getPrintData - Function returning print data object
     * @param {Array} options.additionalSections - Additional sections to include
     */
    init: function(options) {
      this.options = options || {}
      this.bindPrintButtons()
    },

    /**
     * Bind print buttons
     */
    bindPrintButtons: function() {
      document.querySelectorAll('[data-print-calculator]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const calcType = e.target.dataset.printCalculator
          this.printCalculator(calcType)
        })
      })
    },

    /**
     * Main print function
     * @param {string} calculatorType - Type of calculator being printed
     * @param {Object} customData - Custom data to include in print
     */
    printCalculator: function(calculatorType, customData) {
      const printWindow = window.open('', '_blank')
      if (!printWindow) {
        alert('Please allow popups to print')
        return
      }

      const printContent = this.generatePrintContent(calculatorType, customData)
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <title>${this.getCalculatorTitle(calculatorType)} - Print</title>
          <link rel="stylesheet" href="/assets/css/tokens.css">
          <link rel="stylesheet" href="/assets/css/portal.css">
          <link rel="stylesheet" href="/assets/css/calculator-dashboard.css">
          <link rel="stylesheet" href="/assets/css/calculator-print.css">
          <style>
            body { 
              padding: 20px; 
              font-family: 'Segoe UI', Arial, sans-serif;
            }
          </style>
        </head>
        <body>
          ${printContent}
        </body>
        </html>
      `)
      
      printWindow.document.close()
      
      // Wait for styles to load then print
      setTimeout(() => {
        printWindow.focus()
        printWindow.print()
      }, 500)
    },

    /**
     * Generate print content based on calculator type
     */
    generatePrintContent: function(calculatorType, customData) {
      const data = customData || this.extractDataFromPage(calculatorType)
      
      let content = `
        <div class="pc-calc-dashboard">
          ${this.printHeader}
          
          <!-- Print Header -->
          <header class="pc-calc-header">
            <div class="pc-calc-header__title">
              <div class="pc-calc-header__icon">${data.icon || 'üìä'}</div>
              <div class="pc-calc-header__text">
                <h1>${data.title || this.getCalculatorTitle(calculatorType)}</h1>
                <p>${data.subtitle || 'Veterinary Calculator Results'}</p>
              </div>
            </div>
          </header>
      `

      // Patient Information Section
      if (data.patient) {
        content += `
          <section class="print-patient-info page-break-avoid">
            <h3>üêæ Patient Information</h3>
            ${data.patient.species ? `<p><strong>Species:</strong> ${data.patient.species}</p>` : ''}
            ${data.patient.weight ? `<p><strong>Weight:</strong> ${data.patient.weight} kg</p>` : ''}
            ${data.patient.breed ? `<p><strong>Breed:</strong> ${data.patient.breed}</p>` : ''}
            ${data.patient.additional ? data.patient.additional : ''}
          </section>
        `
      }

      // Results Section
      if (data.results && data.results.length > 0) {
        content += `
          <section class="pc-calc-results">
            <div class="pc-calc-panel">
              <div class="pc-calc-panel__header">
                <span class="pc-calc-panel__title">üìã Calculation Results</span>
              </div>
              <div class="pc-calc-panel__content">
                <div class="print-results-grid">
        `

        data.results.forEach((result, index) => {
          const isPrimary = index === 0
          const cardClass = isPrimary ? 'pc-calc-result-card--primary' : 
                           (result.type === 'warning' ? 'pc-calc-result-card--warning' : 
                            (result.type === 'success' ? 'pc-calc-result-card--success' : ''))
          
          content += `
            <div class="pc-calc-result-card ${cardClass} page-break-avoid">
              <div class="pc-calc-result__label">${result.label}</div>
              <div class="pc-calc-result__value">
                ${result.value}
                ${result.unit ? `<span class="pc-calc-result__unit">${result.unit}</span>` : ''}
              </div>
              ${result.context ? `<div class="pc-calc-result__context">${result.context}</div>` : ''}
            </div>
          `
        })

        content += `
                </div>
              </div>
            </div>
          </section>
        `
      }

      // Drug Information Section
      if (data.drug) {
        content += `
          <section class="pc-calc-viz page-break-avoid">
            <div class="pc-calc-viz__header">
              <span class="pc-calc-viz__title">üíä Drug Information</span>
            </div>
            <div class="pc-calc-drug-info">
              <div class="pc-calc-drug-info__header">
                <div class="pc-calc-drug-info__name">${data.drug.name}</div>
                <div class="pc-calc-drug-info__category">${data.drug.category || ''}</div>
              </div>
              <div class="pc-calc-drug-info__grid">
                ${data.dug.doseRange ? `
                  <div class="pc-calc-drug-info__item">
                    <div class="pc-calc-drug-info__label">Dose Range</div>
                    <div class="pc-calc-drug-info__value">${data.drug.doseRange}</div>
                  </div>
                ` : ''}
                ${data.drug.frequency ? `
                  <div class="pc-calc-drug-info__item">
                    <div class="pc-calc-drug-info__label">Frequency</div>
                    <div class="pc-calc-drug-info__value">${data.drug.frequency}</div>
                  </div>
                ` : ''}
                ${data.drug.route ? `
                  <div class="pc-calc-drug-info__item">
                    <div class="pc-calc-drug-info__label">Route</div>
                    <div class="pc-calc-drug-info__value">${data.drug.route}</div>
                  </div>
                ` : ''}
                ${data.drug.form ? `
                  <div class="pc-calc-drug-info__item">
                    <div class="pc-calc-drug-info__label">Form</div>
                    <div class="pc-calc-drug-info__value">${data.drug.form}</div>
                  </div>
                ` : ''}
              </div>
            </div>
          </section>
        `
      }

      // Formula Section
      if (data.formula) {
        content += `
          <section class="pc-calc-viz page-break-avoid">
            <div class="pc-calc-formula">
              <div class="pc-calc-formula__label">Calculation Formula</div>
              <div class="pc-calc-formula__math">${data.formula}</div>
            </div>
          </section>
        `
      }

      // Additional Sections
      if (data.additionalSections) {
        data.additionalSections.forEach(section => {
          content += `
            <section class="pc-calc-viz page-break-avoid">
              <div class="pc-calc-viz__header">
                <span class="pc-calc-viz__title">${section.title}</span>
              </div>
              ${section.content}
            </section>
          `
        })
      }

      // Warnings/Alerts
      if (data.warnings && data.warnings.length > 0) {
        content += `
          <section class="page-break-avoid">
            <div class="pc-calc-alert pc-calc-alert--warning">
              <div class="pc-calc-alert__icon">‚ö†Ô∏è</div>
              <div class="pc-calc-alert__content">
                <div class="pc-calc-alert__title">Important Warnings</div>
                <div class="pc-calc-alert__text">
                  <ul style="margin: 0; padding-left: 1.25rem;">
                    ${data.warnings.map(w => `<li>${w}</li>`).join('')}
                  </ul>
                </div>
              </div>
            </div>
          </section>
        `
      }

      // References
      if (data.reference) {
        content += `
          <section class="page-break-avoid" style="margin-top: 8mm; padding-top: 4mm; border-top: 1px solid #e2e8f0;">
            <div style="font-size: 8pt; color: #64748b;">
              <strong>Reference:</strong> ${data.reference}
            </div>
          </section>
        `
      }

      // Signature Section
      content += `
          <div class="print-signature-section page-break-avoid">
            <p style="font-size: 9pt; margin-bottom: 4mm;">
              <strong>Verified by:</strong> I have verified this calculation against appropriate references and patient parameters.
            </p>
            <div class="print-signature-line"></div>
            <div class="print-signature-label">Signature / Initials & Date</div>
          </div>
        </div>
        
        <!-- Legal Footer -->
        ${this.printFooter}
      `

      return content
    },

    /**
     * Extract data from current page
     */
    extractDataFromPage: function(calculatorType) {
      const data = {
        title: document.querySelector('h1')?.textContent || 'Calculator Results',
        icon: document.querySelector('.pc-calc-header__icon')?.textContent || 'üìä'
      }

      // Extract patient data
      const species = document.getElementById('species')?.value || 
                     document.getElementById('er-species')?.value || ''
      const weight = document.getElementById('weight')?.value || 
                    document.getElementById('er-weight')?.value ||
                    document.getElementById('fluid-weight')?.value || ''

      if (species || weight) {
        data.patient = {
          species: species === 'dog' ? 'üêï Dog' : species === 'cat' ? 'üêà Cat' : species,
          weight: weight
        }
      }

      // Extract results
      data.results = []
      document.querySelectorAll('.pc-calc-result-card').forEach(card => {
        const label = card.querySelector('.pc-calc-result__label')?.textContent?.trim()
        const value = card.querySelector('.pc-calc-result__value')?.childNodes[0]?.textContent?.trim()
        const unit = card.querySelector('.pc-calc-result__unit')?.textContent?.trim()
        const context = card.querySelector('.pc-calc-result__context')?.textContent?.trim()
        
        if (label && value && value !== '--') {
          data.results.push({
            label: label.replace(/[üìäüìãüíâ‚öóÔ∏è]/g, '').trim(),
            value: value,
            unit: unit,
            context: context,
            type: card.classList.contains('pc-calc-result-card--warning') ? 'warning' :
                  card.classList.contains('pc-calc-result-card--success') ? 'success' : 'normal'
          })
        }
      })

      // Extract drug info
      const drugName = document.getElementById('drug-select')?.selectedOptions[0]?.textContent
      if (drugName && !drugName.includes('Select')) {
        data.drug = {
          name: drugName.replace('üîí', '').trim(),
          category: document.getElementById('drug-category')?.textContent || '',
          doseRange: document.getElementById('drug-dose')?.textContent || '',
          frequency: document.getElementById('drug-frequency')?.textContent || '',
          route: document.getElementById('drug-route')?.textContent || ''
        }
      }

      // Extract formula
      const formulaElement = document.querySelector('.pc-calc-formula__math')
      if (formulaElement) {
        data.formula = formulaElement.innerHTML
      }

      // Extract warnings
      const warningElement = document.querySelector('.pc-calc-alert__text') ||
                            document.getElementById('result-warning')
      if (warningElement && warningElement.textContent.trim()) {
        data.warnings = [warningElement.textContent.trim()]
      }

      return data
    },

    /**
     * Get calculator title
     */
    getCalculatorTitle: function(type) {
      const titles = {
        'dose': 'Dose Calculator',
        'fluid': 'Fluid Calculator',
        'cri': 'CRI Calculator',
        'emergency': 'Emergency Drug Chart',
        'transfusion': 'Transfusion Calculator',
        'acid-base': 'Acid-Base Analyzer',
        'unit-converter': 'Unit Converter',
        'glucose': 'Glucose Curve Generator',
        'toxicity': 'Toxicity Calculator',
        'default': 'Veterinary Calculator'
      }
      return titles[type] || titles['default']
    },

    /**
     * Quick print function for specific calculators
     */
    printDoseCalculator: function() {
      this.printCalculator('dose', this.extractDoseData())
    },

    printFluidCalculator: function() {
      this.printCalculator('fluid', this.extractFluidData())
    },

    printCRICalculator: function() {
      this.printCalculator('cri', this.extractCRIData())
    },

    printEmergencyChart: function() {
      this.printCalculator('emergency', this.extractEmergencyData())
    },

    /**
     * Extract specific calculator data
     */
    extractDoseData: function() {
      const data = this.extractDataFromPage('dose')
      data.title = 'Drug Dose Calculation'
      data.subtitle = 'Verified dosing per Plumb\'s Veterinary Drug Handbook'
      data.icon = 'üíä'
      return data
    },

    extractFluidData: function() {
      const data = this.extractDataFromPage('fluid')
      data.title = 'Fluid Therapy Plan'
      data.subtitle = 'Dehydration deficit and maintenance calculations'
      data.icon = 'üíß'
      return data
    },

    extractCRIData: function() {
      const data = this.extractDataFromPage('cri')
      data.title = 'CRI Preparation'
      data.subtitle = 'Constant Rate Infusion calculation'
      data.icon = 'üíâ'
      return data
    },

    extractEmergencyData: function() {
      const data = this.extractDataFromPage('emergency')
      data.title = 'Emergency Drug Dose Chart'
      data.subtitle = 'Verified per RECOVER 2024 Guidelines'
      data.icon = 'üö®'
      
      // Get table data
      const table = document.getElementById('er-drug-table')
      if (table) {
        data.additionalSections = [{
          title: 'Emergency Drug Chart',
          content: table.outerHTML
        }]
      }
      
      return data
    }
  }

  // Expose globally
  window.CalculatorPrint = PrintUtil

  // Auto-bind print buttons
  document.addEventListener('DOMContentLoaded', function() {
    PrintUtil.bindPrintButtons()
  })
})()
